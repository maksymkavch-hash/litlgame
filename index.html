<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GD: The Full Level</title>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; touch-action: none; -webkit-user-select: none; user-select: none; font-family: 'Arial Black', sans-serif; }
        canvas { display: block; width: 100vw; height: auto; aspect-ratio: 2/1; }
    </style>
</head>
<body>
    <canvas id="game"></canvas>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    canvas.width = 800; canvas.height = 400;

    let state = 'MENU', frame = 0, scroll = 0;
    const speed = 9, gravity = 1.4, jumpForce = -19, groundY = 350;
    
    let p = { x: 150, y: 308, w: 42, h: 42, dy: 0, rot: 0, onG: false };
    let obs = [], plats = [], sparks = [], jumpEffects = [];

    // Повний дизайн рівня Stereo Madness (довгий)
    const levelDesign = [
        {t:'S', x:700}, {t:'S', x:1000}, 
        {t:'P', x:1300, y:308, w:42, h:42}, {t:'P', x:1342, y:266, w:42, h:42},
        {t:'P', x:1600, y:180, w:300, h:40}, // Стеля (проїзд під нею)
        {t:'S', x:2000}, {t:'S', x:2045},
        {t:'P', x:2300, y:308, w:100, h:42}, {t:'S', x:2330, y:308}, // Блок з шипом зверху
        {t:'P', x:2600, y:220, w:200, h:30}, {t:'S', x:2900},
        {t:'P', x:3200, y:308, w:42, h:42}, {t:'P', x:3242, y:266, w:42, h:42}, {t:'P', x:3284, y:224, w:42, h:42}, // Сходи
        {t:'S', x:3600}, {t:'S', x:3642}, {t:'S', x:3684}, // Потрійний шип
        {t:'P', x:4000, y:150, w:500, h:40}, // Довгий тунель
        {t:'S', x:4200}, {t:'S', x:4400},
        {t:'P', x:4800, y:308, w:150, h:42}, {t:'P', x:5000, y:250, w:150, h:42}, {t:'P', x:5200, y:200, w:150, h:42},
        {t:'S', x:5500}, {t:'S', x:5545},
        {t:'F', x:6000} // ФІНІШ
    ];

    function init() {
        state = 'PLAYING'; frame = 0; scroll = 0;
        obs = []; plats = []; sparks = []; jumpEffects = [];
        p.y = 308; p.dy = 0; p.rot = 0;
        levelDesign.forEach(d => {
            if(d.t === 'P') plats.push({...d});
            else if(d.t === 'S' || d.t === 'F') obs.push({...d});
        });
    }

    function handleJump(e) {
        if(e) { e.preventDefault(); e.stopPropagation(); }
        if (state !== 'PLAYING') return init();
        if (p.onG) {
            p.dy = jumpForce; p.onG = false;
            jumpEffects.push({x: p.x + p.w/2, y: p.y + p.h, r: 10, a: 1});
        }
    }

    window.addEventListener('keydown', (e) => { if(e.code === 'Space') handleJump(e); }, { capture: true });
    window.addEventListener('touchstart', handleJump, { passive: false });
    window.addEventListener('mousedown', (e) => { if(e.button === 0) handleJump(e); });

    function update() {
        if (state !== 'PLAYING') return;
        frame++; scroll += speed;

        p.dy += gravity; p.y += p.dy;
        p.onG = false;

        if (p.y >= groundY - p.h) { p.y = groundY - p.h; p.dy = 0; p.onG = true; }

        plats.forEach(pl => {
            let rx = pl.x - scroll;
            if (p.x + p.w > rx + 5 && p.x < rx + pl.w - 5 && p.y + p.h > pl.y && p.y < pl.y + pl.h) {
                if (p.y + p.h < pl.y + 25 && p.dy >= 0) {
                    p.y = pl.y - p.h; p.dy = 0; p.onG = true;
                } else if (p.y > pl.y + pl.h - 20) {
                    p.y = pl.y + pl.h; p.dy = 2;
                } else if (p.x + p.w > rx + 5 && p.x + p.w < rx + 25) {
                    state = 'GAMEOVER';
                }
            }
        });

        obs.forEach(o => {
            let rx = o.x - scroll;
            if (o.t === 'F') {
                if (p.x > rx) state = 'WIN';
            } else {
                let oy = o.y || groundY;
                if (p.x + p.w - 15 > rx + 12 && p.x + 15 < rx + 28 && p.y + p.h > oy - 35 && p.y < oy) {
                    state = 'GAMEOVER';
                }
            }
        });

        p.rot = p.onG ? Math.round(p.rot/90)*90 : p.rot + 10;
        if (p.onG && frame % 2 === 0) sparks.push({x: p.x, y: p.y + 36, l: 1});
        sparks.forEach((s, i) => { s.l -= 0.1; if(s.l <= 0) sparks.splice(i,1); });
        jumpEffects.forEach((ef, i) => { ef.r += 4; ef.a -= 0.07; if(ef.a <= 0) jumpEffects.splice(i,1); });
    }

    function draw() {
        let g = ctx.createLinearGradient(0, 0, 0, 400);
        g.addColorStop(0, "#000510"); g.addColorStop(1, "#001a4d");
        ctx.fillStyle = g; ctx.fillRect(0, 0, 800, 400);

        ctx.strokeStyle = "rgba(0, 200, 255, 0.1)";
        for(let i=0; i<=840; i+=60) {
            ctx.beginPath(); ctx.moveTo(i-(scroll%60), 0); ctx.lineTo(i-(scroll%60), 400); ctx.stroke();
        }

        plats.forEach(pl => {
            let rx = pl.x - scroll;
            if (rx < 850 && rx > -pl.w) {
                ctx.fillStyle = "#111"; ctx.fillRect(rx, pl.y, pl.w, pl.h);
                ctx.strokeStyle = "#fff"; ctx.lineWidth = 3; ctx.strokeRect(rx, pl.y, pl.w, pl.h);
            }
        });

        obs.forEach(o => {
            let rx = o.x - scroll;
            if (rx < 850 && rx > -50) {
                if (o.t === 'F') {
                    ctx.fillStyle = "#fff"; ctx.fillRect(rx, 0, 10, 400);
                    ctx.font = "40px Arial Black"; ctx.fillText("FINISH", rx + 30, 200);
                } else {
                    let oy = o.y || groundY;
                    ctx.fillStyle = "#ff2222"; ctx.beginPath();
                    ctx.moveTo(rx, oy); ctx.lineTo(rx+20, oy-40); ctx.lineTo(rx+40, oy); ctx.fill();
                    ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.stroke();
                }
            }
        });

        jumpEffects.forEach(ef => {
            ctx.strokeStyle = `rgba(255,255,255,${ef.a})`;
            ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(ef.x, ef.y, ef.r, 0, Math.PI*2); ctx.stroke();
        });

        ctx.fillStyle = "#00f7ff"; ctx.fillRect(0, groundY, 800, 3);
        sparks.forEach(s => { ctx.fillStyle = `rgba(255,255,255,${s.l})`; ctx.fillRect(s.x-10, s.y, 6, 6); });

        ctx.save();
        ctx.translate(p.x + p.w/2, p.y + p.h/2);
        ctx.rotate(p.rot * Math.PI / 180);
        ctx.shadowBlur = 15; ctx.shadowColor = "#ffff00";
        ctx.fillStyle = "#ffff00"; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        ctx.strokeStyle = "#000"; ctx.lineWidth = 4; ctx.strokeRect(-p.w/2, -p.h/2, p.w, p.h);
        ctx.fillStyle = "#000"; ctx.fillRect(-14, -14, 10, 10); ctx.fillRect(4, -14, 10, 10);
        ctx.restore(); ctx.shadowBlur = 0;

        if (state !== 'PLAYING') {
            ctx.fillStyle = "rgba(0,0,0,0.8)"; ctx.fillRect(0,0,800,400);
            ctx.fillStyle = "#fff"; ctx.textAlign = "center"; ctx.font = "bold 35px Arial";
            let msg = state === 'MENU' ? "STEREO MADNESS" : (state === 'WIN' ? "LEVEL COMPLETE!" : "TRY AGAIN");
            ctx.fillText(msg, 400, 200);
            ctx.font = "18px Arial"; ctx.fillText("КЛІК АБО ПРОБІЛ", 400, 240);
        }

        update(); requestAnimationFrame(draw);
    }
    draw();
</script>
</body>
</html>
